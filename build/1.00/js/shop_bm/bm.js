/*
 * Build by xuelei.kong@autostreets.com
 * Date: 2016-04-07 10:30:42
 * Version: 1.00
 */
function carBrands(){function e(e){var a=e.data;brandListWrap.empty(),$.each(a,function(e,a){$("#"+a.firstPinyin.toLowerCase()+"_dt").length||(brandListWrap.append('<dl><dt  id="'+a.firstPinyin.toLowerCase()+'_dt">'+a.firstPinyin+"</dt><dd><ul id="+a.firstPinyin.toLowerCase()+"_ul></ul></dd></dl>"),letterIndex.append('<a href="javascript:void(0)">'+a.firstPinyin+"</a>")),$("#"+a.firstPinyin.toLowerCase()+"_ul").append('<li data-brandSid="'+a.sid+'" data-brand="'+a.brand+'"><div class="img_wrap"><img src="'+imgUrl+a.logoUrl+'" alt=""/></div><p>'+a.brand+"</p></li>")});var t=scrollMe("#brand_list");$(".letter_index a").css({lineHeight:$(".letter_index").height()/$(".letter_index a").length+"px",height:$(".letter_index").height()/$(".letter_index a").length+"px"}).click(function(){var e=$(this).index()+1;return t.scrollToElement(document.querySelector("#brand_list dl:nth-child("+e+")"),300),!1})}bm_api.call(maintenancePort.carBrands,e)}function getCarSeries(e){seriesListWrap.empty(),$.each(e.data,function(e,a){console.log(a);var t=a.brand;$("h2#mdBrand"+t).length||seriesListWrap.append('<div class="hd_wrap"><h2 class="hd" id=mdBrand'+t+">"+t+'</h2></div><ul data-mdBrand="'+t+'" id="list'+t+'"></ul>'),$("#list"+t).append('<li><a date-brand="'+a.brand+'"data-series="'+a.series+'" href="'+staticUrl+"bm_complete_car_list.html?seriesSid="+a.sid+'"></div><div class="img_wrap">'+img(a.seriesUrl)+"</div><h3>"+a.series+"</h3></a></li>")})}function getModelList(){function e(e){e.data&&$.each(e.data,function(e,t){var i=t.mdYear;$("h2#mdYear"+i).length||a.append('<div class="hd_wrap"><h2 class="hd" id=mdYear'+i+">"+i+'</h2></div><ul data-mdyear="'+i+'" id="list'+i+'"></ul>'),$("#list"+i).append('<li data-sid="'+t.sid+'"><a data-model="'+t.model+'" data-mdyear="'+i+'" data-sid="'+t.sid+'"   href="'+staticUrl+"bm_save_my_car.html?modelSid="+t.sid+'"><div class="img_wrap">'+img(t.modelUrl)+"</div><h3>"+t.model+"</h3></a></li>")})}var a=$("#complete_car_list");bm_api.call(maintenancePort.selectModel,e,{seriesSid:GetQueryString("seriesSid"),current:0})}function shop(){function e(e){function a(e){var a='<ul class="bm_shop_bd">';return $.each(e,function(e,t){a+='<li><a class="package_item_link link" href="'+staticUrl+"bm_package_detail.html?id="+t.id+'"><h3>'+t.name+"</h3><p>适用车型："+t.applicableModels+'</p><span class="fee">&yen;<span>'+t.packagePrice+"</span></span></a></li>"}),a+="</ul>"}var t="";e.data&&(e.data.length||isNotEmptyObj(e.data))?$.each(e.data,function(e,i){var r=i.maintainPackages?a(i.maintainPackages):"",s=i.brandLogo?"<img class='brandLogo' src='"+imgUrl+i.brandLogo+"'>":"",n=i.distance?'<div class="distance"><span>'+(i.distance/1e3).toFixed(2)+"km</span></div>":"";t+='<li data-orgSid="'+i.orgSid+'" class="bm_shop"><a class="shop_item_link link" href="'+staticUrl+"bm_shop_detail.html?orgSid="+i.orgSid+'"><div class="bm_shop_hd"><div class="img_wrap">'+img(i.photoUrl)+'</div><div class="bm_shop_r"><h3>'+s+i.orgNameAbbr+'</h3><div class="stars">'+createScore(i.score)+'</div><div class="location">'+i.address+"</div>"+n+"</div></div></a>"+r+"</li>"}):t=noResult("很抱歉，没有符合条件的门店"),$(".bm_shop_list").append(t)}bm_api.call(maintenancePort.shopList,e,{scviSid:scviSid,sortType:currentSortTypeVal,lat:lat,lng:lng,province:currentProvince,city:currentCity,name:searchShopName,current:current})}function shopDetail(){function e(e){function a(){var e='<div class="bm_shop_box"><div id="service_list"><div class="service_list">';return $.each(r.tagList,function(a,t){e+='<span class="service_item"><img src="http://img.autostreetscdn.com/m/build/1.00/images/shop_bm/select.png" alt="">'+t+"</span>"}),e+="</div></div></div>"}function t(){for(var e=0;3>e;e++){var a=s.shift(),t=arguments[0]?0:"auto",i="undefined"!=typeof a.applicableModels?a.applicableModels:"通用";packageHtml=$('<li style="height:'+t+'" class="package"><a class="package_link" href="javascript:void(0)"><div class="package_l"><h3>'+a.name+"</h3><p>适用车型："+i+'</p></div><div class="package_r"><p class="curr_price">&yen;<span>'+a.packagePrice+'</span></p><s class="origin_price">&yen;'+a.originalPrice+"</s></div></a></li>"),$(".package_list").first().append(packageHtml);var r=$(".package").height();if(arguments[0]&&packageHtml.css({height:r}),!s.length)return void d.hide()}}function i(){var e="";return $.each(n,function(a,t){e+='<li class="adviser"><a class="adviser_link" href="javscript:void(0)"><div class="img_wrap">'+img(t.photoUrl)+'</div><p class="adviser_name">'+t.name+'</p><div class="stars">'+createScore(t.score)+"</div></a></li>"}),e}var r=e.data,s=(r.distance?$(".bm_shop_r").append('<div class="distance"><span>'+(r.distance/1e3).toFixed(2)+"km</span></div>"):$(".distance").hide(),r.maintainPackages),n=r.consultantInfos,d=$(".view_more");$(img(r.photoUrl)).appendTo($(".bm_shop_hd .img_wrap")),$(".shop_name").html(r.orgNameAbbr),$(".shop_time span").html(r.beginTime+"-"+r.endTime),$(".shop_description").append(r.description?r.description.replace(/\r\n/g,"<br/>"):""),$(".main_brand").append(r.brand?r.brand:"所有品牌"),"undefined"==typeof r.tagList?$("#service_list").parents(".bm_shop_box").hide():($(".tel").parent().after(a()),$(".service_item").width(winW/3),$(".service_list").width(r.tagList.length*(winW/3)),scrollMe("#service_list","horizon")),scrollMe("#adviser_list","horizon"),"undefined"==typeof n?$("#adviser_list").parent(".bm_shop_box").hide().prev("h2").hide():($(".adviser_list").append(i()),$(".adviser").width(winW/3),$(".adviser_list").width(r.consultantInfos.length*(winW/3)),scrollMe("#adviser_list","horizon")),s.length?(s.length>3?d.css("display","block"):d.hide(),t(),d.on("click",function(){t(!0)})):($(".package_list").parents(".bm_shop_box").hide(),$(".package_list").parents().prev("h2").hide()),$(".bm_shop_r .stars").append(createScore(r.score)),$(".map_location").prop("href","http://wx.autostreets.com/html/map.html?lat="+r.latitude+"&lng="+r.longitude+"&name="+r.orgNameAbbr+"&addr="+r.address).find("p").html(r.address),$(".tel").prop("href","tel:"+r.telephone).find("p").html(r.telephone);var l={orgSid:r.orgSid,src:imgUrl+r.brandLogo,name:r.orgNameAbbr,addr:r.address};localStorage.shopInfo=JSON.stringify(l)}function a(e){if(e.data){var a=GetQueryString("brandLogo"),t=GetQueryString("orgNameAbbr"),i=GetQueryString("address"),r=GetQueryString("orgSid");console.log(a,t,i,r),$("#select_shop").prop("href",staticUrl+"bm_by_order.html?brandLogo="+a+"&orgNameAbbr="+t+"&address="+i+"&orgSid="+r)}else $("#select_shop").addClass("grey_long_btn")}bm_api.call(maintenancePort.shopDetail,e,{orgSid:GetQueryString("orgSid"),lat:lat,lng:lng}),localStorage.defaultVid&&bm_api.call(maintenancePort.isMatchOrgan,a,{scviSid:scviSid,orgSid:GetQueryString("orgSid")}),$("#select_shop").on("click",function(){localStorage.defaultVid||require(["custVehicle"],function(e){e.newVehicle()})})}function getMyCarDetail(){function e(e){var a=e.data;$(".my_car_title").html(a.selledName),$(".drive_distance").val(a.currentMiles),$(".img_wrap").append(img(a.logoUrl)),$(".drive_date").val(new Date(a.firstDate).Format("yyyy-MM"))}bm_api.call(maintenancePort.myCarDetail,e,{scviSid:GetQueryString("scviSid")})}function getMyCarList(){function e(e){var a=e.data;$.each(a,function(e,a){var t=a.defaultVehicle?"radio_checked":"";$(".my_car_list ul").append('<li data-id="'+a.id+'" class="my_car"><div class="my_car_desc"><div class="img_wrap">'+img(a.logoUrl)+'</div><p class="car_info"><span class="car_title">'+a.selledName+'</span><span class="car_dis">新车上路时间：'+new Date(a.firstDate).Format("yyyy-MM")+'</span></p></div><div class="my_car_opt"><span class="set_default module_radio '+t+' ">设为默认</span><p><a href="bm_save_my_car.html?scviSid='+a.id+"&modelSid="+a.modelSid+'&from=list" class="edit edit_icon">编辑</a><a href="javascript:void(0)" class="delete delete_icon">删除</a></p></div></li>')})}bm_api.call(maintenancePort.myCarList,e,{memberSid:memberSid})}function orderList(){function e(e){var a=e.data;a&&$.each(a,function(e,t){$("#bm_my_order_list").append('<div class="brd_box order_list_item status_'+t.orderStatus+'"><div class="order_info"><a href="'+staticUrl+"bm_my_order_detail.html?orderNo="+t.orderNo+"&orderStatus="+t.orderStatus+'" class="order_detail_link"><div class="img_wrap">'+img(a.modelUrl)+'</div><div class="r"><h3>'+t.orgNameAbbr+"</h3><p>"+t.maintainName+'</p><p class="r_sub"><span class="status">'+t.statusDesc+'</span><span class="fee">&yen;'+t.amount+"</span></p></div></a></div>"+getBtns(t.orderStatus,t.orderNo)+"</div>")})}bm_api.call(maintenancePort.orderList,e,{memberSid:sessionStorage.memberSid,current:0})}function orderDetail(){function e(e){function a(){return t.timeDiscountRate?'<i class="discount">'+t.timeDiscountRate+"折</i><span>"+new Date(t.appointTime).Format("yyyy-MM-dd  hh:mm")+"</span>":"<span>"+new Date(t.appointTime).Format("yyyy-MM-dd  hh:mm")+"</span>"}var t=e.data;if(t){var i=$(".order_detail"),r=t.orderStatus;if(t.organ&&$(".img_wrap").append(img(t.organ.brandLogo)),$(".fee").html("&yen;"+t.amount),$(".maintainName").html(t.maintainName),$(".orderNo").html(t.orderNo),$("#bm_my_order_detail").append(getBtns(t.orderStatus,t.orderNo)),$(".banner").append(getBanner(t.orderStatus,t.statusDesc)),t.maintenItems.length){var s='<a href="javascript:void(0)" class="order_item_hd">保养项目<i class="w_9_arr"></i></a><ul class="order_item_bd bm_item">';i.append(""),$.each(t.maintenItems,function(e,a){s+='<li class="bm_item_li">'+a+"</li>"}),s+="</ul>",i.append(s),$(".bm_item").height(0).data("height",i.find(".bm_item_li").length*$(".bm_item_li").height())}if(t.packageItems.length){var n='<a href="javascript:void(0)" class="order_item_hd">优惠套餐<i class="w_9_arr"></i></a><ul class="order_item_bd package_item ">';i.append(""),$.each(t.packageItems,function(e,a){n+='<li class="pack_item">'+a.name+"<span>&yen;"+a.packagePrice+"</span></li>"}),n+="</ul>",i.append(n),$(".package_item").height(0).data("height",i.find(".pack_item").length*$(".pack_item").height())}$(".bm_adviser .r_val").html(t.consultant.name),$(".name").html(t.custName),$(".mobile").html(t.phone).prop("href","tel:"+t.phone),$(".shop_info h3 span").append(t.organ.orgNameAbbr),$(".store_addr").append(t.organ.address),$(".tel_icon").prop("href","tel:"+t.organ.telephone),$(".home_icon").prop("href",staticUrl+"bm_shop_detail.html?orgSid="+t.organ.orgSid),$(".bm_time .r_val").append(a()),$(".order_num .r_val").append(t.orderNo),$(".order_time .r_val").append(new Date(t.createTime).Format("yyyy/MM/dd  hh:mm")),$(".bm_car .r_val").html(t.custVehicleInfo),$(".adviser_tel").prop("href","tel:"+t.consultant.cellphone),$(".view_map").prop("href","http://wx.autostreets.com/html/map.html?lat="+t.organ.latitude+"&lng="+t.organ.longitude+"&name="+t.organ.orgNameAbbr+"&addr="+t.organ.address),function(){if(0==r)return void $(".expense_code").hide();var e="",a="",i="",s=new Date(t.appointTime).Format("yyyy-MM-dd hh:mm"),n=t.orderStatus,n="有效期";6==r||7==r?(n=t.statusDesc,a="has_refund",i='<a href="bm_refund_detail.html?orderNo='+t.orderNo+"&amount="+t.amount+'" class="refund_detail_link">[退款当前状态]'+n+"，点击查看退款详情]</a>",s="&yen;"+t.amount):8==r?n="预约时间":(9==r||10==r)&&(n=t.statusDesc),(9==r||2==r||6==r||7==r||5==r||10==r)&&(e="expense_code_used");var d='<div class="expense_info"><div class="flex_box"><div class="l"><span>消费码</span><p class="expense_code_status '+e+'">'+t.orderNo+'</p></div><div class="flex '+a+'"><span>'+n+"</span><p>"+s+"</p></div></div>"+i+"</div>";$(".expense_code").append(d)}()}}bm_api.call(maintenancePort.orderDetail,e,{orderNo:GetQueryString("orderNo")})}function getBanner(e,a){var t="";return(2==e||10==e||9==e)&&(t="warning"),(0==e||1==e||3==e||6==e)&&(t="waiting"),1==e&&(a="待服务"),(8==e||5==e||4==e||7==e)&&(t="over"),11==e&&(t="waiting",a="待服务"),'<div class="order_banner '+t+'"><i class="orderStatusIcon"></i><p class="orderStatus">订单状态：<span>'+a+"</span></p></div>"}function getBtns(e,a){function t(e,t,i,r){if("付款"==i)s=sitUrl;else var s=sitUrl+"html/shop_bm/";var n=e?s+e+a:"javascript:void(0)",r=r?"id="+r:"";return"<a "+r+' data-orderno="'+a+'" href="'+n+'" class="order_btn '+t+'">'+i+"</a>"}var i='<div class="order_opt">';switch(e){case 8:i+=t("bm_cancel_order.html?orderNo=","grey_order_btn","取消订单"),i+="</div>";break;default:i=""}return i}function img(e){return e?'<img class="bm_img " src="'+imgUrl+e+'" alt="">':""}var brandListWrap=$(".iScroll_brand_list"),seriesListWrap=$(".iScroll_series_list"),brandList=$("#brand_list"),seriesList=$("#series_list"),letterIndex=$(".letter_index");if($("#bm_complete_car").length&&carBrands(),$("#series_list").length&&bm_api.call(maintenancePort.carSeries,getCarSeries,{brandSid:$(this).data("brandsid")}),seriesList.on("click","a",function(){carInfo={},carInfo.brand=$(this).parent().parent().data("mdbrand"),carInfo.series=$(this).data("series"),console.log(carInfo.brand,carInfo.series),localStorage.cust_vehicle_info=JSON.stringify(carInfo)}),$("#complete_car_list").on("click","a",function(){carInfo=JSON.parse(localStorage.cust_vehicle_info),carInfo.model=$(this).data("model"),carInfo.mdYear=$(this).data("mdyear"),localStorage.cust_vehicle_info=JSON.stringify(carInfo)}),$("#complete_car_list").length&&getModelList(),$("#bm_shop_list").length&&scrollLoading(shop),$("#bm_shop_detail").length&&getCurrentLatLon(shopDetail),$("#my_car").length)if(GetQueryString("scviSid"))getMyCarDetail();else{var carInfo=JSON.parse(localStorage.cust_vehicle_info);$(".img_wrap").append('<img src="'+carInfo.brandLogo+'" class="my_car_logo" alt=""/>'),$(".my_car_title").append(carInfo.mdYear+" "+carInfo.brand+" "+carInfo.series+" "+carInfo.model)}if($("#edit_my_car").length&&getMyCarList(),$(".bm_tab a").click(function(){$(this).addClass("curr").siblings().removeClass("curr");var e=$(this).index();switch($("#bm_my_order_list").length&&(0==e&&$(".order_list_item").show()||1==e&&$(".order_list_item").hide()&&$(".status_0").show()||2==e&&$(".order_list_item").hide()&&$(".status_1").show()||3==e&&$(".order_list_item").hide()&&$(".status_4").show()),e){case 0:$(".coupon").show();break;case 1:$(".status0").show(),$(".status1,.status2,.status8").hide();break;case 2:$(".status2").show(),$(".status0,.status1,.status8").hide();break;case 3:$(".status8").show(),$(".status0,.status1,.status2").hide()}}),$(".cancel_reason li").click(function(){$(this).addClass("selected").siblings().removeClass("selected")}),$(".stars span").click(function(){}),$("#bm_my_order_list").length)if("undefined"!=typeof sessionStorage.memberSid&&sessionStorage.memberSid)orderList();else{var url="http://wx.autostreets.com/member/getMember",member=null;$.ajax({url:url,type:"GET",dataType:"jsonp",jsonp:"jsoncallback",success:function(e){function a(){var e=sessionStorage.memberSid;$.ajax({type:"get",async:!1,url:"http://wx.autostreets.com/customerVehicle/updateCustVehicles",data:{defaultId:localStorage.defaultVid,memberSid:e,ids:localStorage.vids},success:function(a){a.success&&t(e)}})}function t(e){$.ajax({type:"get",async:!1,url:"http://wx.autostreets.com/customerVehicle/list",data:{memberSid:e},success:function(e){if(e.success){e=e.data,localStorage.removeItem("vids"),localStorage.defaultVid=e[0].id,r();for(var a=e.length-1;a>=0;a--)i(e[a])}}})}function i(e){if(localStorage.setItem(e.id,JSON.stringify(e)),e.id!=localStorage.defaultVid){var a=localStorage.vids;if(a){var t=[];t=a.split(",");for(var i=0;i<t.length;i++)t[i]==e.id&&t.splice(i,1);sessionStorage.memberSid?t.length>7&&(localStorage.removeItem(t[7]),t=t.slice(0,7)):t.length>2&&(localStorage.removeItem(t[2]),t=t.slice(0,2)),a=t.join(","),localStorage.setItem("vids",e.id+","+a)}else localStorage.vids=e.id}if(localStorage.defaultVid){var r=JSON.parse(localStorage.getItem(localStorage.defaultVid));r.defaultVehicle=!1,localStorage.setItem(localStorage.defaultVid,JSON.stringify(r))}localStorage.defaultVid=e.id}function r(){var e=localStorage.getItem("vids"),a=[];e&&(a=e.split(","));for(var t=0;t<a.length;t++)localStorage.removeItem(a[t]);localStorage.removeItem("vids"),localStorage.removeItem("defaultVid")}e.success&&(member=e.data,sessionStorage.memberSid=member.sid,sessionStorage.member_info=JSON.stringify(member),a(),orderList())}})}window.onscroll=function(){var e=document.documentElement.scrollTop||document.body.scrollTop,a=(document.documentElement.scrollHeight||document.body.scrollHeight,$(".hd_wrap")),t=a.height();$.each(a,function(i,r){var s=$(r),n=this.offsetTop;s.find(".hd").css(e+headerH>=n?{position:"fixed",top:headerH}:{position:"relative",top:0}),0!=i&&a.eq(i-1).find(".hd").css(e+headerH+t>=n?{marginTop:n-t-e-headerH}:{marginTop:0})})},$("#bm_my_order_detail").length&&(orderDetail(),$(".order_detail").on("click",".order_item_hd",function(){var e=$(this),a=e.next();0==a.height()?e.next().height(e.next().data("height")):a.height(0),e.find("i").toggleClass("toggle_arr")})),($("#bm_refund_detail").length||$("#bm_refund").length||$("#bm_comment").length)&&($(".expense_code").html(GetQueryString("orderNo")),function(){function e(e){if(e.data){{var a=e.data.refundProcess;e.data.reason}$(".fee").html("&yen;"+e.data.amount),a&&$.each(a,function(e,a){e++;var t=a.isEnabled?"curr":"",i=a.time?new Date(a.time).Format("yyyy/MM/dd  hh:mm"):"";$(".refund_status_list").append("<li>"+a.step+"<i class="+t+">"+e+"</i><span>"+i+"</span></li>")}),$("#bm_refund").length&&($(".cancel_title").html(e.data.maintainName),$(".refund_sum").html("&yen;"+e.data.amount)),$("#bm_comment").length&&($(".img_wrap").empty().append(img(e.data.organ.photoUrl)),$("h3").html(e.data.maintainName))}}bm_api.call(maintenancePort.orderDetail,e,{orderNo:GetQueryString("orderNo")})}()),$("#bm_comment").length&&$(".level").click(function(){var e=$(this).parent().find(".level"),a=$(this).index();e.each(function(){$(this).index()<=a?$(this).find("i").addClass("full"):$(this).find("i").removeClass("full")})});